#!/bin/bash
# remote-syslog-start â€” Generate config and start remote_syslog daemon
#
# Reads syslog_host and syslog_port from /proc/cmdline and generates
# /run/log_files.yml, then starts remote_syslog in foreground.
#
# Kernel cmdline parameters:
#   syslog_host=<hostname>  - Syslog server hostname/IP (required)
#   syslog_port=<port>      - Syslog server port (default: 514)
#   syslog_proto=<proto>    - Protocol: udp, tcp, or tls (default: udp)

set -euo pipefail

# Parse kernel cmdline
CMDLINE=$(cat /proc/cmdline)
SYSLOG_HOST=""
SYSLOG_PORT="514"
SYSLOG_PROTO="udp"

for param in $CMDLINE; do
    case "$param" in
        syslog_host=*)  SYSLOG_HOST="${param#syslog_host=}" ;;
        syslog_port=*)  SYSLOG_PORT="${param#syslog_port=}" ;;
        syslog_proto=*) SYSLOG_PROTO="${param#syslog_proto=}" ;;
    esac
done

# Exit cleanly if no syslog server configured
if [[ -z "$SYSLOG_HOST" ]]; then
    echo "remote-syslog: No syslog_host= in cmdline, syslog forwarding disabled"
    # Sleep forever so systemd doesn't restart us
    exec sleep infinity
fi

echo "remote-syslog: Forwarding logs to ${SYSLOG_HOST}:${SYSLOG_PORT} (${SYSLOG_PROTO})"

# Get hostname from /etc/hostname or kernel cmdline
HOSTNAME=$(cat /etc/hostname 2>/dev/null || hostname || echo "captainos")

# Create runtime config directory and empty log file
mkdir -p /run/log
touch /run/log/journal.log

# Generate config file
cat > /run/log_files.yml << EOF
files:
  - /run/log/journal.log
destination:
  host: ${SYSLOG_HOST}
  port: ${SYSLOG_PORT}
  protocol: ${SYSLOG_PROTO}
hostname: ${HOSTNAME}
new_file_check_interval: 5
exclude_files:
  - .gz
  - .tmp
EOF

# Start remote_syslog in foreground (no daemonize)
exec /usr/local/bin/remote_syslog -D -c /run/log_files.yml
